<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TFT Powerup Optimizer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-color: #f9f9f9;
      --text-color: #333;
      --container-bg: white;
      --border-color: #ddd;
      --primary-color: #3498db;
      --primary-hover: #2980b9;
      --error-color: #e74c3c;
      --success-color: #27ae60;
      --highlight-color: #e67e22;
      --sidebar-bg: #f9f9f9;
      --powerup-info-bg: #e8f4fc;
    }

    .dark-mode {
      --bg-color: #1a1a1a;
      --text-color: #f0f0f0;
      --container-bg: #2d2d2d;
      --border-color: #444;
      --primary-color: #2980b9;
      --primary-hover: #3498db;
      --error-color: #ff6b6b;
      --success-color: #2ecc71;
      --highlight-color: #f39c12;
      --sidebar-bg: #2d2d2d;
      --powerup-info-bg: #1e3a56;
    }

    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      padding: 20px; 
      max-width: 1200px; 
      margin: auto; 
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }

    h2 { 
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 10px;
    }

    .credits {
      text-align: center;
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 25px;
    }

    .main-content {
      display: flex;
      gap: 20px;
      flex: 1;
    }

    .container {
      background-color: var(--container-bg);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 2;
      transition: background-color 0.3s;
    }

    .sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .info-panel, .favorites-panel {
      background-color: var(--sidebar-bg);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: background-color 0.3s;
    }

    .favorites-panel {
      max-height: 500px;
      overflow-y: auto;
    }

    label { 
      margin: 15px 0 5px;
      font-weight: bold;
      color: var(--primary-color);
    }

    select, input, button { 
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 15px;
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      background-color: var(--container-bg);
      color: var(--text-color);
      transition: all 0.3s;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
      margin-top: 20px;
      padding: 12px;
    }

    button:hover {
      background-color: var(--primary-hover);
    }

    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    ul { 
      padding-left: 0;
      list-style-type: none;
    }

    li { 
      margin-bottom: 10px;
      padding: 10px;
      background-color: var(--container-bg);
      border-radius: 4px;
      border-left: 4px solid var(--primary-color);
      transition: background-color 0.3s;
    }

    .champion-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .favorite-btn {
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 18px;
      padding: 5px;
      margin-left: auto;
      transition: color 0.3s;
    }

    .favorite-btn:hover {
      color: #ff6b6b;
    }

    .favorite-btn.favorited {
      color: #ff6b6b;
    }

    .loading {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
    }

    .error {
      color: var(--error-color);
      font-weight: bold;
    }

    .success {
      color: var(--success-color);
    }

    .highlight {
      font-weight: bold;
      color: var(--highlight-color);
    }

    .powerup-info {
      margin-top: 20px;
    }

    .powerup-info h3 {
      margin-top: 0;
      color: var(--primary-color);
    }

    .powerup-description {
      padding: 15px;
      background-color: var(--powerup-info-bg);
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .favorite-group {
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      transition: border-color 0.3s;
    }

    .favorite-group-header {
      background-color: var(--primary-color);
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s;
    }

    .favorite-group-header-content {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .favorite-group-header strong,
    .favorite-group-header span {
      line-height: 1;
      vertical-align: baseline;
    }

    .favorite-group-content {
      padding: 10px;
      background-color: var(--container-bg);
      transition: background-color 0.3s;
    }

    .favorite-group-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
      transition: border-color 0.3s;
    }

    .favorite-group-item:last-child {
      border-bottom: none;
    }

    .group-remove-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      margin-left: 10px;
      padding: 0 5px;
    }

    .item-remove-btn {
      background: none;
      border: none;
      color: var(--error-color);
      cursor: pointer;
      margin-left: auto;
      padding: 2px 5px;
    }

    .favorites-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .clear-favorites {
      background: none;
      border: none;
      color: var(--error-color);
      cursor: pointer;
      font-size: 14px;
    }

    .powerup-tier {
      width: 20px;
      height: 20px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .powerup-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .powerup-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .powerup-icon {
      width: 40px;
      height: 40px;
    }

    .powerup-tier-badge {
      width: 30px;
      height: 30px;
    }

    .tier-s {
      color: #ff3333;
    }
    .tier-a {
      color: #ff9933;
    }
    .tier-b {
      color: #ffcc33;
    }
    .tier-c {
      color: #66ccff;
    }
    .tier-d {
      color: #cccccc;
    }

    option[data-tier="S"] {
      background-color: rgba(255, 50, 50, 0.1);
    }
    option[data-tier="A"] {
      background-color: rgba(255, 150, 50, 0.1);
    }
    option[data-tier="B"] {
      background-color: rgba(255, 255, 50, 0.1);
    }
    option[data-tier="C"] {
      background-color: rgba(100, 200, 255, 0.1);
    }
    option[data-tier="D"] {
      background-color: rgba(200, 200, 200, 0.1);
    }

    .header-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
    }

    .theme-toggle {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .lang-select-wrapper {
      background-color: var(--container-bg);
      border-radius: 20px;
      padding: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .lang-select {
      padding: 5px 10px;
      border: 1px solid var(--border-color);
      border-radius: 15px;
      background-color: var(--container-bg);
      color: var(--text-color);
      font-size: 14px;
      cursor: pointer;
    }

    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
        gap: 40px;
      }

      .container,
      .sidebar {
        flex: unset;
        width: 100%;
      }

      .container {
        order: 1;
      }

      .sidebar {
        order: 2;
      }

      .favorites-panel,
      .info-panel {
        max-height: none;
        overflow: visible;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      h2 {
        font-size: 22px;
      }

      label,
      select,
      input,
      button {
        font-size: 15px;
      }

      .champion-icon {
        width: 28px;
        height: 28px;
      }

      .favorite-btn {
        font-size: 16px;
      }

      .favorite-group-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .favorite-group-item {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
      }

      .header-controls {
        top: 10px;
        right: 10px;
      }

      .theme-toggle {
        width: 35px;
        height: 35px;
      }

      .lang-select {
        padding: 5px 8px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="header-controls">
    <div class="lang-select-wrapper">
      <select class="lang-select" id="langSelect">
        <option value="pt">PT</option>
        <option value="en">EN</option>
      </select>
    </div>
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
    </button>
  </div>

  <h2>TFT Powerup Optimizer</h2>
  <div class="credits">by decarstes</div>

  <div class="main-content">
    <div class="container">
      <label for="championSelect">Champion:</label>
      <select id="championSelect" disabled>
        <option value="">Loading champions...</option>
      </select>

      <label for="powerupSelect">Powerup:</label>
      <select id="powerupSelect" disabled>
        <option value="">Select a champion first</option>
      </select>

      <button id="analyzeBtn" onclick="analisar()" disabled>Analyze</button>

      <h3>Best champions to use before:</h3>
      <ul id="resultList">
        <li class="loading">Select a champion and powerup to analyze</li>
      </ul>
    </div>

    <div class="sidebar">
      <div class="info-panel">
        <h3>Powerup Information</h3>
        <div class="powerup-info" id="powerupInfo" style="display: none;">
          <div class="powerup-header">
            <img src="https://cdn.metatft.com/cdn-cgi/image/width=40,height=40,format=auto/https://cdn.metatft.com/file/metatft/set15/PowerUp_Item_Consumable.png" alt="Powerup" class="powerup-icon">
            <h4 id="powerupName"></h4>
            <img id="powerupTierBadge" src="" alt="Tier" class="powerup-tier-badge" style="display: none;">
          </div>
          <div class="powerup-description" id="powerupDescription"></div>
        </div>
      </div>

      <div class="favorites-panel">
        <div class="favorites-title">
          <h3>Favorites <i class="fas fa-heart" style="color: #ff6b6b;"></i></h3>
          <button class="clear-favorites" onclick="clearFavorites()">Clear All</button>
        </div>
        <ul id="favoritesList">
          <li class="loading">No favorites yet</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const GIST_BASE_URL = 'https://gist.githubusercontent.com/renewrocha/8bb6c5b1157871e6618ff4c1681c269b/raw/';
    
    let data = [];
    let currentLanguage = 'pt';
    let championData = {};
    let powerupDescriptions = {};
    let powerupRankings = {};
    let favorites = JSON.parse(localStorage.getItem('tft_favorites')) || [];
    let darkMode = localStorage.getItem('darkMode') === 'true';

    const champSelect = document.getElementById("championSelect");
    const powerupSelect = document.getElementById("powerupSelect");
    const resultList = document.getElementById("resultList");
    const langSelect = document.getElementById("langSelect");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const powerupInfo = document.getElementById("powerupInfo");
    const powerupName = document.getElementById("powerupName");
    const powerupDescription = document.getElementById("powerupDescription");
    const powerupTierBadge = document.getElementById("powerupTierBadge");
    const favoritesList = document.getElementById("favoritesList");
    const themeToggle = document.getElementById("themeToggle");

    // Inicializa o tema
    function initTheme() {
      if (darkMode) {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        document.body.classList.remove('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      }
    }

    // Alternar tema
    themeToggle.addEventListener('click', () => {
      darkMode = !darkMode;
      localStorage.setItem('darkMode', darkMode);
      initTheme();
    });

    // Inicializa o tema ao carregar
    initTheme();

    function formatChampionNameForIcon(championName) {
      return championName
        .toLowerCase()
        .replace(/'/g, '')
        .replace(/\./g, '')
        .replace(/\s+/g, '')
        .replace(/[^a-z0-9]/g, '');
    }

    function getChampionIcon(championName) {
      const formattedName = formatChampionNameForIcon(championName);
      return `https://cdn.metatft.com/cdn-cgi/image/width=48,height=48,format=auto/https://cdn.metatft.com/file/metatft/champions/tft15_${formattedName}.png`;
    }

    function getTierIcon(tier) {
      const tierIcons = {
        'S': 'https://blitz-cdn-plain.blitz.gg/blitz/ui/icons/tier-icon/tier-s.svg',
        'A': 'https://blitz-cdn-plain.blitz.gg/blitz/ui/icons/tier-icon/tier-a.svg',
        'B': 'https://blitz-cdn-plain.blitz.gg/blitz/ui/icons/tier-icon/tier-b.svg',
        'C': 'https://blitz-cdn-plain.blitz.gg/blitz/ui/icons/tier-icon/tier-c.svg',
        'D': 'https://blitz-cdn-plain.blitz.gg/blitz/ui/icons/tier-icon/tier-d.svg'
      };
      return tierIcons[tier] || '';
    }

    function showLoading() {
      resultList.innerHTML = '<li class="loading">Loading data...</li>';
    }

    function showError(message) {
      resultList.innerHTML = `<li class="error">${message}</li>`;
    }

    async function loadPowerupRankings() {
      try {
        const response = await fetch(`${GIST_BASE_URL}tft_powerup_ranking_${currentLanguage}.json?${Date.now()}`);
        if (!response.ok) throw new Error('Failed to load powerup rankings');
        powerupRankings = await response.json();
      } catch (error) {
        console.error("Error loading powerup rankings:", error);
        powerupRankings = [];
      }
    }

    async function carregarDados() {
      showLoading();
      currentLanguage = langSelect.value;
      
      try {
        const [championsResponse, descriptionsResponse] = await Promise.all([
          fetch(`${GIST_BASE_URL}tft_powerups_${currentLanguage}.json?${Date.now()}`),
          fetch(`${GIST_BASE_URL}tft_powerup_desc_${currentLanguage}.json?${Date.now()}`),
          loadPowerupRankings()
        ]);
        
        if (!championsResponse.ok) throw new Error(`HTTP error! status: ${championsResponse.status}`);
        if (!descriptionsResponse.ok) throw new Error(`HTTP error! status: ${descriptionsResponse.status}`);
        
        const [loadedData, loadedDescriptions] = await Promise.all([
          championsResponse.json(),
          descriptionsResponse.json()
        ]);
        
        data = loadedData;
        powerupDescriptions = {};
        
        loadedDescriptions.forEach(desc => {
          powerupDescriptions[desc.nome || desc.name] = {
            description: desc.descricao || desc.description,
            tier: desc.tier || 'D'
          };
        });
        
        championData = {};
        data.forEach(entry => {
          championData[entry.champion] = {
            powerups: entry.powerups,
          };
        });
        
        preencherCampeoes();
        updateFavoritesList();
      } catch (error) {
        console.error("Error loading file:", error);
        showError(currentLanguage === 'pt' 
          ? "Erro ao carregar os dados. Por favor, tente recarregar a página." 
          : "Error loading data. Please try reloading the page.");
      }
    }

    function preencherCampeoes() {
      champSelect.innerHTML = "";
      
      const sortedChampions = [...data].sort((a, b) => a.champion.localeCompare(b.champion));
      
      sortedChampions.forEach(entry => {
        const opt = document.createElement("option");
        opt.value = entry.champion;
        
        const iconUrl = getChampionIcon(entry.champion);
        opt.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <img src="${iconUrl}" alt="${entry.champion}" style="width: 20px; height: 20px; border-radius: 50%;">
            ${entry.champion}
          </div>
        `;
        
        champSelect.appendChild(opt);
      });
      
      champSelect.disabled = false;
      analyzeBtn.textContent = currentLanguage === 'pt' ? 'Analisar' : 'Analyze';
      
      if (data.length > 0) {
        champSelect.selectedIndex = 0;
        atualizarFrutas();
      }
    }

    async function atualizarFrutas() {
      const selectedChampion = champSelect.value;
      const champion = championData[selectedChampion];
      
      powerupSelect.innerHTML = "";
      
      if (champion) {
        await loadPowerupRankings();
        
        const sortedPowerups = [...champion.powerups].sort((a, b) => {
          const tierA = (powerupRankings.find(p => p.nome === a) || {}).tier || 'D';
          const tierB = (powerupRankings.find(p => p.nome === b) || {}).tier || 'D';
          
          const tierOrder = { 'S': 0, 'A': 1, 'B': 2, 'C': 3, 'D': 4 };
          
          if (tierOrder[tierA] !== tierOrder[tierB]) {
            return tierOrder[tierA] - tierOrder[tierB];
          }
          return a.localeCompare(b);
        });
        
        sortedPowerups.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p;
          
          const powerupRank = powerupRankings.find(item => item.nome === p);
          const tier = powerupRank ? powerupRank.tier : null;
          
          opt.innerHTML = p;
          
          if (tier) {
            opt.dataset.tier = tier;
          }
          
          powerupSelect.appendChild(opt);
        });
        
        powerupSelect.disabled = false;
        analyzeBtn.disabled = false;
        updatePowerupInfo();
      } else {
        powerupSelect.disabled = true;
        analyzeBtn.disabled = true;
      }
    }

    function updatePowerupInfo() {
      const selectedPowerup = powerupSelect.value;
      
      if (selectedPowerup && powerupDescriptions[selectedPowerup]) {
        powerupName.textContent = selectedPowerup;
        powerupDescription.textContent = powerupDescriptions[selectedPowerup].description;
        
        // Atualizar tier badge
        const powerupRank = powerupRankings.find(item => item.nome === selectedPowerup);
        const tier = powerupRank ? powerupRank.tier : null;
        
        if (tier) {
          powerupTierBadge.src = getTierIcon(tier);
          powerupTierBadge.alt = `Tier ${tier}`;
          powerupTierBadge.title = `Tier ${tier}`;
          powerupTierBadge.style.display = 'inline';
          powerupName.className = `tier-${tier.toLowerCase()}`;
        } else {
          powerupTierBadge.style.display = 'none';
          powerupName.className = '';
        }
        
        powerupInfo.style.display = 'block';
      } else {
        powerupInfo.style.display = 'none';
      }
    }

    function toggleFavorite(targetChampion, powerup, recommendedChampion) {
      const existingIndex = favorites.findIndex(fav => 
        fav.target === targetChampion && 
        fav.powerup === powerup && 
        fav.recommended === recommendedChampion
      );
      
      if (existingIndex === -1) {
        favorites.push({
          target: targetChampion,
          powerup: powerup,
          recommended: recommendedChampion,
          timestamp: new Date().getTime()
        });
      } else {
        favorites.splice(existingIndex, 1);
      }
      
      favorites.sort((a, b) => b.timestamp - a.timestamp);
      
      localStorage.setItem('tft_favorites', JSON.stringify(favorites));
      updateFavoritesList();
      updateFavoriteButtons(targetChampion, powerup);
    }

    function clearFavorites() {
      if (confirm(currentLanguage === 'pt' 
          ? "Tem certeza que deseja limpar todos os favoritos?" 
          : "Are you sure you want to clear all favorites?")) {
        favorites = [];
        localStorage.setItem('tft_favorites', JSON.stringify(favorites));
        updateFavoritesList();
      }
    }

    function loadFavoriteCombo(favorite) {
      champSelect.value = favorite.target;
      champSelect.dispatchEvent(new Event('change'));
      
      setTimeout(() => {
        powerupSelect.value = favorite.powerup;
        powerupSelect.dispatchEvent(new Event('change'));
        analisar();
      }, 100);
    }

    function updateFavoritesList() {
      favoritesList.innerHTML = "";
      
      if (favorites.length === 0) {
        favoritesList.innerHTML = `<li class="loading">${
          currentLanguage === 'pt' 
            ? "Nenhum favorito ainda" 
            : "No favorites yet"
        }</li>`;
        return;
      }

      const groupedFavorites = {};
      favorites.forEach(fav => {
        const key = `${fav.target}|${fav.powerup}`;
        if (!groupedFavorites[key]) {
          groupedFavorites[key] = {
            target: fav.target,
            powerup: fav.powerup,
            items: []
          };
        }
        groupedFavorites[key].items.push(fav);
      });

      const sortedGroups = Object.values(groupedFavorites)
        .sort((a, b) => {
          const aLatest = Math.max(...a.items.map(i => i.timestamp));
          const bLatest = Math.max(...b.items.map(i => i.timestamp));
          return bLatest - aLatest;
        });

      sortedGroups.forEach(group => {
        const groupElement = document.createElement('div');
        groupElement.className = 'favorite-group';
        
        const targetIcon = getChampionIcon(group.target);
        
        groupElement.innerHTML = `
          <div class="favorite-group-header">
            <div class="favorite-group-header-content">
              <img src="${targetIcon}" alt="${group.target}" style="width: 20px; height: 20px; border-radius: 50%;">
              <strong>${group.target}</strong>
              <span>+ ${group.powerup}</span>
            </div>
            <button class="group-remove-btn" onclick="removeFavoriteGroup('${group.target.replace(/'/g, "\\'")}', '${group.powerup.replace(/'/g, "\\'")}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="favorite-group-content" id="group-${group.target}-${group.powerup}">
          </div>
        `;
        
        favoritesList.appendChild(groupElement);
        
        const groupContent = document.getElementById(`group-${group.target}-${group.powerup}`);
        group.items.forEach(fav => {
          const itemElement = document.createElement('div');
          itemElement.className = 'favorite-group-item';
          
          const recommendedIcon = getChampionIcon(fav.recommended);
          
          itemElement.innerHTML = `
            <img src="${recommendedIcon}" alt="${fav.recommended}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 8px;">
            <span>${fav.recommended}</span>
            <button class="item-remove-btn" onclick="removeFavoriteItem(event, '${fav.target.replace(/'/g, "\\'")}', '${fav.powerup.replace(/'/g, "\\'")}', '${fav.recommended.replace(/'/g, "\\'")}')">
              <i class="fas fa-times"></i>
            </button>
          `;
          
          groupContent.appendChild(itemElement);
        });
      });
    }

    function removeFavoriteGroup(target, powerup) {
      if (confirm(currentLanguage === 'pt' 
          ? `Remover todas as recomendações para ${target} + ${powerup}?` 
          : `Remove all recommendations for ${target} + ${powerup}?`)) {
        favorites = favorites.filter(fav => 
          !(fav.target === target && fav.powerup === powerup)
        );
        localStorage.setItem('tft_favorites', JSON.stringify(favorites));
        updateFavoritesList();
        updateFavoriteButtons(target, powerup);
      }
    }

    function removeFavoriteItem(event, target, powerup, recommended) {
      event.stopPropagation();
      favorites = favorites.filter(fav => 
        !(fav.target === target && 
          fav.powerup === powerup && 
          fav.recommended === recommended)
      );
      localStorage.setItem('tft_favorites', JSON.stringify(favorites));
      updateFavoritesList();
      updateFavoriteButtons(target, powerup);
    }

    function updateFavoriteButtons(targetChampion, powerup) {
      document.querySelectorAll('.favorite-btn').forEach(btn => {
        const recommendedChampion = btn.getAttribute('data-champion');
        const isFavorite = favorites.some(fav => 
          fav.target === targetChampion && 
          fav.powerup === powerup && 
          fav.recommended === recommendedChampion
        );
        
        if (isFavorite) {
          btn.classList.add('favorited');
        } else {
          btn.classList.remove('favorited');
        }
      });
    }

    function analisar() {
      if (data.length === 0) {
        showError(currentLanguage === 'pt' 
          ? "Dados ainda não carregados. Aguarde." 
          : "Data not loaded yet. Please wait.");
        return;
      }

      const alvoNome = champSelect.value;
      const frutaDesejada = powerupSelect.value.trim().toLowerCase();
      const alvo = championData[alvoNome];
      
      if (!alvo || !frutaDesejada) {
        showError(currentLanguage === 'pt' 
          ? "Por favor, preencha todos os campos corretamente." 
          : "Please fill all fields correctly.");
        return;
      }

      const poolAlvo = new Set(alvo.powerups.map(p => p.toLowerCase()));
      
      if (!poolAlvo.has(frutaDesejada)) {
        showError(currentLanguage === 'pt' 
          ? `⚠️ O campeão ${alvoNome} não possui a fruta "${powerupSelect.value}".` 
          : `⚠️ Champion ${alvoNome} doesn't have the "${powerupSelect.value}" powerup.`);
        return;
      }

      resultList.innerHTML = '<li class="loading">Analyzing combinations...</li>';
      
      setTimeout(() => {
        const candidatos = data
          .filter(c => c.champion !== alvoNome && !c.champion.includes('[H]'))
          .map(c => {
            const comum = c.powerups.filter(p => poolAlvo.has(p.toLowerCase()));
            const possuiFruta = c.powerups.some(p => p.toLowerCase() === frutaDesejada);
            const isFavorite = favorites.some(fav => 
              fav.target === alvoNome && 
              fav.powerup === powerupSelect.value && 
              fav.recommended === c.champion
            );
            
            return {
              nome: c.champion,
              comuns: comum,
              exclui: comum.length,
              temFrutaDesejada: possuiFruta,
              icon: getChampionIcon(c.champion),
              isFavorite: isFavorite
            };
          })
          .filter(c => !c.temFrutaDesejada && c.exclui > 0)
          .sort((a, b) => b.exclui - a.exclui || a.nome.localeCompare(b.nome));

        exibirResultados(candidatos, alvoNome, powerupSelect.value);
      }, 50);
    }

    function exibirResultados(candidatos, alvoNome, frutaDesejada) {
      resultList.innerHTML = "";
      
      if (candidatos.length === 0) {
        showError(currentLanguage === 'pt' 
          ? `Nenhum campeão encontrado que exclua frutas em comum com ${alvoNome} sem ter "${frutaDesejada}".` 
          : `No champions found that exclude common powerups with ${alvoNome} without having "${frutaDesejada}".`);
        return;
      }

      const header = document.createElement('li');
      header.innerHTML = currentLanguage === 'pt' 
        ? `<span class="highlight">Resultados para ${alvoNome} com "${frutaDesejada}":</span>` 
        : `<span class="highlight">Results for ${alvoNome} with "${frutaDesejada}":</span>`;
      resultList.appendChild(header);

      candidatos.forEach(c => {
        const li = document.createElement("li");
        
        li.innerHTML = `
          <img src="${c.icon}" alt="${c.nome}" class="champion-icon">
          <div>
            <strong>${c.nome}</strong> (${
              currentLanguage === 'pt' 
                ? `exclui ${c.exclui} frutas` 
                : `excludes ${c.exclui} powerups`
            }: ${c.comuns.join(", ")})
          </div>
          <button class="favorite-btn ${c.isFavorite ? 'favorited' : ''}" 
                  onclick="toggleFavorite('${alvoNome.replace(/'/g, "\\'")}', '${frutaDesejada.replace(/'/g, "\\'")}', '${c.nome.replace(/'/g, "\\'")}')"
                  data-champion="${c.nome.replace(/'/g, "\\'")}">
            <i class="fas fa-heart"></i>
          </button>
        `;
        resultList.appendChild(li);
      });
    }

    // Event listeners
    langSelect.addEventListener("change", carregarDados);
    champSelect.addEventListener("change", atualizarFrutas);
    powerupSelect.addEventListener("change", updatePowerupInfo);
    
    // Carregamento inicial
    document.addEventListener('DOMContentLoaded', carregarDados);
  </script>
</body>
</html>
